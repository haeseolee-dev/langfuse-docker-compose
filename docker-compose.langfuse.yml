version: "3.8"

services:
  langfuse-minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: langfuse-minio
    entrypoint: sh
    command: -c 'mkdir -p /data/langfuse && minio server --address ":9000" --console-address ":9001" /data'
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-miniosecret}
    volumes:
      - langfuse_minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 1s
      timeout: 5s
      retries: 5
      start_period: 1s
    restart: unless-stopped
    networks:
      - autobuilder-network

  langfuse-clickhouse:
    image: clickhouse/clickhouse-server:25.12.3
    container_name: langfuse-clickhouse
    environment:
      - CLICKHOUSE_DB=${CLICKHOUSE_DB:-langfuse}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-langfuse}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'clickhouse-client --host 127.0.0.1 --user "$${CLICKHOUSE_USER}" --password "$${CLICKHOUSE_PASSWORD}" -q "SELECT 1" >/dev/null 2>&1',
        ]
      interval: 5s
      timeout: 5s
      retries: 40
      start_period: 20s
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - langfuse_clickhouse_data:/var/lib/clickhouse
      - ${LANGFUSE_CLICKHOUSE_INIT_DIR:-/data/langfuse_clickhouse_init}:/docker-entrypoint-initdb.d:ro
      - ${LANGFUSE_CLICKHOUSE_LISTEN_CONFIG:-/data/langfuse_clickhouse_conf/10-listen.xml}:/etc/clickhouse-server/config.d/10-listen.xml:ro
    restart: unless-stopped
    networks:
      - autobuilder-network

  # Background worker
  langfuse-worker:
    image: langfuse/langfuse-worker:3.146.0
    container_name: langfuse-worker
    depends_on:
      # langfuse-postgres:
      #   condition: service_healthy
      # langfuse-redis:
      #   condition: service_healthy
      langfuse-clickhouse:
        condition: service_healthy
      langfuse-minio:
        condition: service_healthy
    env_file:
      - .env.${ENVIRONMENT}
    restart: unless-stopped
    networks:
      - autobuilder-network

  # Web/UI + API
  langfuse:
    image: langfuse/langfuse:3.146.0
    container_name: langfuse
    depends_on:
      # langfuse-postgres:
      #   condition: service_healthy
      # langfuse-redis:
      #   condition: service_healthy
      langfuse-clickhouse:
        condition: service_healthy
      langfuse-minio:
        condition: service_healthy
    ports:
      - "${LANGFUSE_PORT:-19001}:3000"
    env_file:
      - .env.${ENVIRONMENT}
    environment:
      - CLICKHOUSE_CLUSTER_ENABLED=false
      - CLICKHOUSE_MIGRATION_SSL=false
    restart: unless-stopped
    networks:
      - autobuilder-network

networks:
  autobuilder-network:
    external: true

volumes:
  langfuse_clickhouse_data:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/data/langfuse_clickhouse"

  langfuse_minio_data:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/data/langfuse_minio"
