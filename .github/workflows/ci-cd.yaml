name: langfuse-stack-ci-cd

env:
  BRANCH: ${{ github.ref_name }}

  TARGET_HOST: 20.214.145.17
  TARGET_HOST_PORT: ${{ vars.TARGET_SSH_PORT }}
  TARGET_HOST_USER: ${{ vars.TARGET_SSH_USER }}

  ENVIRONMENT: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
  USE_MINIO: ${{ vars.LANGFUSE_USE_MINIO != '' && vars.LANGFUSE_USE_MINIO || 'true' }}

permissions:
  contents: read

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}
          fetch-depth: 1

      - name: Prepare secrets (mask + export)
        shell: bash
        run: |
          set -euo pipefail

          TARGET_HOST_PASSWORD="${{ secrets.TARGET_HOST_PASSWORD }}"

          REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"
          LANGFUSE_POSTGRES_PASSWORD="${{ secrets.LANGFUSE_POSTGRES_PASSWORD }}"

          LANGFUSE_NEXTAUTH_SECRET="${{ secrets.LANGFUSE_NEXTAUTH_SECRET }}"
          LANGFUSE_SALT="${{ secrets.LANGFUSE_SALT }}"
          LANGFUSE_CLICKHOUSE_PASSWORD="${{ secrets.LANGFUSE_CLICKHOUSE_PASSWORD }}"

          LANGFUSE_ENCRYPTION_KEY="${{ secrets.LANGFUSE_ENCRYPTION_KEY }}"
          if [ -z "${LANGFUSE_ENCRYPTION_KEY}" ]; then
            LANGFUSE_ENCRYPTION_KEY="$(openssl rand -hex 32)"
          fi

          if [ "${{ env.USE_MINIO }}" = "true" ]; then
            LANGFUSE_MINIO_ROOT_PASSWORD="${{ secrets.LANGFUSE_MINIO_ROOT_PASSWORD }}"
            if [ -z "${LANGFUSE_MINIO_ROOT_PASSWORD}" ]; then
              LANGFUSE_MINIO_ROOT_PASSWORD="${LANGFUSE_CLICKHOUSE_PASSWORD}"
            fi
            LANGFUSE_AZURE_STORAGE_ACCOUNT_NAME=""
            LANGFUSE_AZURE_STORAGE_ACCOUNT_KEY=""
          else
            LANGFUSE_AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.LANGFUSE_AZURE_STORAGE_ACCOUNT_NAME }}"
            LANGFUSE_AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.LANGFUSE_AZURE_STORAGE_ACCOUNT_KEY }}"
            LANGFUSE_MINIO_ROOT_PASSWORD=""
          fi

          echo "::add-mask::${TARGET_HOST_PASSWORD}"
          echo "::add-mask::${REDIS_PASSWORD}"
          echo "::add-mask::${LANGFUSE_POSTGRES_PASSWORD}"
          echo "::add-mask::${LANGFUSE_NEXTAUTH_SECRET}"
          echo "::add-mask::${LANGFUSE_SALT}"
          echo "::add-mask::${LANGFUSE_CLICKHOUSE_PASSWORD}"
          echo "::add-mask::${LANGFUSE_ENCRYPTION_KEY}"
          echo "::add-mask::${LANGFUSE_MINIO_ROOT_PASSWORD}"
          echo "::add-mask::${LANGFUSE_AZURE_STORAGE_ACCOUNT_NAME}"
          echo "::add-mask::${LANGFUSE_AZURE_STORAGE_ACCOUNT_KEY}"

          {
            echo "TARGET_HOST_PASSWORD=${TARGET_HOST_PASSWORD}"
            echo "REDIS_PASSWORD=${REDIS_PASSWORD}"
            echo "LANGFUSE_POSTGRES_PASSWORD=${LANGFUSE_POSTGRES_PASSWORD}"
            echo "LANGFUSE_NEXTAUTH_SECRET=${LANGFUSE_NEXTAUTH_SECRET}"
            echo "LANGFUSE_SALT=${LANGFUSE_SALT}"
            echo "LANGFUSE_CLICKHOUSE_PASSWORD=${LANGFUSE_CLICKHOUSE_PASSWORD}"
            echo "LANGFUSE_ENCRYPTION_KEY=${LANGFUSE_ENCRYPTION_KEY}"
            echo "LANGFUSE_MINIO_ROOT_PASSWORD=${LANGFUSE_MINIO_ROOT_PASSWORD}"
            echo "LANGFUSE_AZURE_STORAGE_ACCOUNT_NAME=${LANGFUSE_AZURE_STORAGE_ACCOUNT_NAME}"
            echo "LANGFUSE_AZURE_STORAGE_ACCOUNT_KEY=${LANGFUSE_AZURE_STORAGE_ACCOUNT_KEY}"
          } >> "${GITHUB_ENV}"

      - name: Build .env.${{ env.ENVIRONMENT }}
        shell: bash
        run: |
          set -euo pipefail
          ENV_FILE=".env.${{ env.ENVIRONMENT }}"
          rm -f "${ENV_FILE}"

          {
            echo "ENVIRONMENT=${{ env.ENVIRONMENT }}"
            echo "USE_MINIO=${{ env.USE_MINIO }}"
            echo "NODE_ENV=production"

            echo "LANGFUSE_PORT=19001"
            echo "NEXTAUTH_URL=http://${{ env.TARGET_HOST }}:19001"
            echo "NEXTAUTH_SECRET=${{ env.LANGFUSE_NEXTAUTH_SECRET }}"
            echo "SALT=${{ env.LANGFUSE_SALT }}"
            echo "ENCRYPTION_KEY=${{ env.LANGFUSE_ENCRYPTION_KEY }}"
            echo "TELEMETRY_ENABLED=false"

            echo "DATABASE_URL=postgresql://langfuse:${{ env.LANGFUSE_POSTGRES_PASSWORD }}@langfuse-postgres:5432/langfuse?schema=public"

            echo "REDIS_URL=redis://:${{ env.REDIS_PASSWORD }}@langfuse-redis:6379"
            echo "REDIS_CONNECTION_STRING=redis://:${{ env.REDIS_PASSWORD }}@langfuse-redis:6379"
            echo "REDIS_TLS_ENABLED=false"

            echo "CLICKHOUSE_URL=http://langfuse-clickhouse:8123"
            echo "CLICKHOUSE_MIGRATION_URL=clickhouse://langfuse-clickhouse:9000"
            echo "CLICKHOUSE_USER=langfuse"
            echo "CLICKHOUSE_DB=langfuse"
            echo "CLICKHOUSE_PASSWORD=${{ env.LANGFUSE_CLICKHOUSE_PASSWORD }}"
            echo "CLICKHOUSE_CLUSTER_ENABLED=false"

            echo "MINIO_ROOT_USER=minio"
            echo "MINIO_ROOT_PASSWORD=${{ env.LANGFUSE_MINIO_ROOT_PASSWORD }}"
            echo "LANGFUSE_USE_AZURE_BLOB=false"

            echo "LANGFUSE_S3_EVENT_UPLOAD_BUCKET=langfuse"
            echo "LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT=http://langfuse-minio:9000"
            echo "LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID=minio"
            echo "LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=${{ env.LANGFUSE_MINIO_ROOT_PASSWORD }}"
            echo "LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE=true"
            echo "LANGFUSE_S3_EVENT_UPLOAD_PREFIX=events/"

            echo "LANGFUSE_S3_EVENT_UPLOAD_REGION=us-east-1"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_BUCKET=langfuse"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT=http://langfuse-minio:9000"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID=minio"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY=${{ env.LANGFUSE_MINIO_ROOT_PASSWORD }}"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE=true"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_PREFIX=media/"

            echo "LANGFUSE_S3_MEDIA_UPLOAD_REGION=us-east-1"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_BUCKET=langfuse"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT=http://langfuse-minio:9000"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID=minio"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY=${{ env.LANGFUSE_MINIO_ROOT_PASSWORD }}"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE=true"
            echo "LANGFUSE_S3_MEDIA_UPLOAD_PREFIX=media/"
          } >> "${ENV_FILE}"

      - name: Upload artifacts to target via SCP
        uses: appleboy/scp-action@v1
        with:
          host: ${{ env.TARGET_HOST }}
          username: ${{ env.TARGET_HOST_USER }}
          password: ${{ env.TARGET_HOST_PASSWORD }}
          port: ${{ env.TARGET_HOST_PORT }}
          source: |
            docker-compose.langfuse.yml,
            docker-compose.db.yml,
            docker/init,
            docker/clickhouse,
            .env.${{ env.ENVIRONMENT }}
          target: "~/deploy/langfuse"

      - name: Deploy on target host (2-phase)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.TARGET_HOST }}
          username: ${{ env.TARGET_HOST_USER }}
          password: ${{ env.TARGET_HOST_PASSWORD }}
          port: ${{ env.TARGET_HOST_PORT }}
          script: |
            set -euo pipefail

            mkdir -p ~/deploy/langfuse
            cd ~/deploy/langfuse

            ENV_FILE=".env.${{ env.ENVIRONMENT }}"
            trap 'rm -f "$ENV_FILE"' EXIT

            DOCKER="sudo ENVIRONMENT=${{ env.ENVIRONMENT }} docker"
            PROJECT="${{ env.ENVIRONMENT }}-langfuse"

            # Persistent dirs
            sudo mkdir -p \
              /data/langfuse_postgres \
              /data/langfuse_redis \
              /data/langfuse_clickhouse \
              /data/langfuse_minio \
              /data/langfuse_clickhouse_conf \
              /data/langfuse_clickhouse_init

            # Permissions
            sudo chown -R 999:999 /data/langfuse_postgres || true
            sudo chown -R 999:999 /data/langfuse_redis || true
            sudo chown -R 101:101 /data/langfuse_clickhouse || true
            sudo chown -R 65532:65532 /data/langfuse_minio || true

            # Persist ClickHouse config/init
            sudo cp -f docker/clickhouse/10-listen.xml /data/langfuse_clickhouse_conf/10-listen.xml
            sudo cp -a docker/init/. /data/langfuse_clickhouse_init/
            sudo chmod +x /data/langfuse_clickhouse_init/*.sh || true

            echo "=== Phase 0: DB services (postgres + redis) ==="
            $DOCKER compose -p "$PROJECT" --env-file "$ENV_FILE" -f docker-compose.db.yml up -d

            # Wait for PostgreSQL to become healthy
            echo "Waiting for PostgreSQL to become healthy..."
            for i in $(seq 1 60); do
              status="$($DOCKER inspect -f '{{.State.Health.Status}}' langfuse-postgres 2>/dev/null || echo 'unknown')"
              if [ "$status" = "healthy" ]; then
                echo "PostgreSQL is healthy."
                break
              fi
              if [ "$i" -eq 60 ]; then
                echo "ERROR: PostgreSQL did not become healthy in time." >&2
                $DOCKER logs --tail 200 langfuse-postgres || true
                exit 1
              fi
              sleep 2
            done

            # Force update PostgreSQL password (fixes authentication issues with existing data volumes)
            # echo "Updating PostgreSQL password..."
            # $DOCKER exec langfuse-postgres psql -U langfuse -d postgres -c "ALTER USER langfuse WITH PASSWORD '${{ env.LANGFUSE_POSTGRES_PASSWORD }}';" || echo "Warning: Failed to update PostgreSQL password, continuing..."

            echo "=== Phase 1: ClickHouse first (and wait healthy) ==="
            $DOCKER compose -p "$PROJECT" --env-file "$ENV_FILE" -f docker-compose.langfuse.yml up -d --force-recreate langfuse-clickhouse

            # Wait for ClickHouse healthcheck
            echo "Waiting for ClickHouse to become healthy..."
            for i in $(seq 1 60); do
              status="$($DOCKER inspect -f '{{.State.Health.Status}}' langfuse-clickhouse 2>/dev/null || echo 'unknown')"
              if [ "$status" = "healthy" ]; then
                echo "ClickHouse is healthy."
                break
              fi
              if [ "$i" -eq 60 ]; then
                echo "ERROR: ClickHouse did not become healthy in time." >&2
                $DOCKER logs --tail 200 langfuse-clickhouse || true
                exit 1
              fi
              sleep 2
            done

            echo "=== Phase 1b: MinIO (optional) ==="
            if [ "${{ env.USE_MINIO }}" = "true" ]; then
              $DOCKER compose -p "$PROJECT" --env-file "$ENV_FILE" -f docker-compose.langfuse.yml up -d --force-recreate langfuse-minio
              echo "Waiting for MinIO to become healthy..."
              for i in $(seq 1 30); do
                status="$($DOCKER inspect -f '{{.State.Health.Status}}' langfuse-minio 2>/dev/null || echo 'unknown')"
                if [ "$status" = "healthy" ]; then
                  echo "MinIO is healthy."
                  break
                fi
                if [ "$i" -eq 30 ]; then
                  echo "ERROR: MinIO did not become healthy in time." >&2
                  $DOCKER logs --tail 200 langfuse-minio || true
                  exit 1
                fi
                sleep 2
              done
            fi

            echo "=== Phase 2: Langfuse web + worker ==="
            $DOCKER compose -p "$PROJECT" --env-file "$ENV_FILE" -f docker-compose.langfuse.yml up -d --force-recreate langfuse-worker langfuse

            echo "=== Status ==="
            $DOCKER ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            echo "=== Logs (last 120 lines) ==="
            $DOCKER logs --tail 120 langfuse || true
            $DOCKER logs --tail 120 langfuse-worker || true

            # Cleanup deploy artifacts (optional)
            rm -rf docker/ || true
            rm -f docker-compose.langfuse.yml docker-compose.db.yml || true
