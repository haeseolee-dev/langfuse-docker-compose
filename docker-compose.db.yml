version: "3.8"

services:
  langfuse-postgres:
    image: postgres:16-alpine
    container_name: langfuse-postgres
    environment:
      POSTGRES_USER: ${LANGFUSE_POSTGRES_USER:-langfuse}
      POSTGRES_PASSWORD: ${LANGFUSE_POSTGRES_PASSWORD:-langfusesecret}
      POSTGRES_DB: ${LANGFUSE_POSTGRES_DB:-langfuse}
    volumes:
      - langfuse_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 3s
      timeout: 5s
      retries: 30
      start_period: 10s
    restart: unless-stopped
    networks:
      - autobuilder-network

  langfuse-redis:
    image: redis:7-alpine
    container_name: langfuse-redis
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - langfuse_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 5s
      retries: 30
      start_period: 5s
    restart: unless-stopped
    networks:
      - autobuilder-network

volumes:
  langfuse_postgres_data:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/data/langfuse_postgres"

  langfuse_redis_data:
    driver: local
    driver_opts:
      type: "none"
      o: "bind"
      device: "/data/langfuse_redis"

networks:
  autobuilder-network:
    external: true
